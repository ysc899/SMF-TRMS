--  Generate SQL 
--  Version:                   V7R2M0 140418 
--  Generated on:              22/03/22 18:23:55 
--  Relational Database:       NEODIN 
--  Standards Option:          DB2 for i 
--DROP SPECIFIC PROCEDURE MCLISOLIB.SEL04_CORONAREPORT_MC600M_POSITIVE_CTVALUE_SP ; 
--SET PATH "QSYS","QSYS2","SYSPROC","SYSIBMADM","NEO018" ; 
CREATE OR REPLACE PROCEDURE MCLISOLIB.SEL04_CORONAREPORT_MC600M_POSITIVE_CTVALUE_SP ( 
  IN $P_COR CHAR(3) , 
  IN $P_FDAT VARCHAR(8) , 
  IN $P_TDAT VARCHAR(8) , 
  IN $P_LOGID VARCHAR(50) , 
  IN $P_HOSCD VARCHAR(5) ) 
  DYNAMIC RESULT SETS 1 
  LANGUAGE SQL 
  SPECIFIC MCLISOLIB.SEL04_CORONAREPORT_MC600M_POSITIVE_CTVALUE_SP 
  NOT DETERMINISTIC 
  MODIFIES SQL DATA 
  CALLED ON NULL INPUT 
  SET OPTION  ALWBLK = *ALLREAD , 
  ALWCPYDTA = *OPTIMIZE , 
  COMMIT = *NONE , 
  DECRESULT = (31, 31, 00) , 
  DYNDFTCOL = *NO , 
  DYNUSRPRF = *USER , 
  SRTSEQ = *HEX 
  BEGIN 
DECLARE CUR1 CURSOR FOR 
SELECT 
F600HOS AS HOSCD  --병원코드 
, F120FNM AS HOSNM  --병원명 
, GUBUN 
--, TRIM ( F100NAM ) || '(' || F100DAT || '/' || F100JN12 || F100ETC || ')' AS PATIENTNM 
, TRIM ( F100NAM ) AS NAM 
, TRIM ( SUBSTRING ( REPLACE ( REPLACE ( REPLACE ( REPLACE ( REPLACE ( REPLACE ( REPLACE ( REPLACE ( REPLACE ( REPLACE ( REPLACE ( REPLACE ( F100DAT , '2027' , '2021' ) , '2028' , '2021' ) , '2029' , '2021' ) , '2030' , '2021' ) , '2023' , '2022' ) , '2024' , '2022' ) , '2025' , '2022' ) , '2026' , '2022' ) , '2037' , '2022' ) , '2038' , '2022' ) , '2039' , '2022' ) , '2000' , '2020' ) , 1 , 4 ) || '-' || SUBSTRING ( F100DAT , 5 , 2 ) || '-' || SUBSTRING ( F100DAT , 7 , 2 ) ) AS DAT 
, TRIM ( F100JN12 ) AS JN12 
, TRIM ( F100ETC ) AS ETC 
, ( SELECT TRIM ( SUBSTRING ( S100PNO , 1 , 3 ) || '-' || SUBSTRING ( S100PNO , 4 , 4 ) || '-' || SUBSTRING ( S100PNO , 8 , 4 ) ) 
	FROM MCLISDLIB . MC100HSUB@ WHERE 1 = 1 
	AND S100COR = F100COR 
	AND S100DAT = F100DAT 
	AND S100JNO = F100JNO 
	AND S100HOS = F100HOS ) AS PNO 
, EGN  --E gene 
, RGN  --RdRP/S gene 
, NGN  --N gene 
, F600CDT  -- 보고일자 (지점(남부,안양) - 요청으로 정렬을 위해 추가) 
, F600CTM  -- 보고시간 (지점(남부,안양) - 요청으로 정렬을 위해 추가) 
, ( SELECT S100TMP10 
	FROM MCLISDLIB . MC100HSUB@ WHERE 1 = 1 
	AND S100COR = F100COR 
	AND S100DAT = F100DAT 
	AND S100JNO = F100JNO 
	AND S100HOS = F100HOS ) AS ADDRESS 
FROM 
( 
SELECT 
F100COR , F100JNO , F600HOS , F120FNM , F100NAM 
--, SUBSTRING ( F100DAT , 5 , 9 ) AS F100DAT 
, F100DAT , F100HOS 
-- 2022.01.06 복호화 제거 
--, CASE WHEN LENGTH ( TRIM ( F100JN2 ) ) > 0 THEN ECHELON . PI_DECSN ( F100JN1 ) || '-' || SUBSTRING ( ECHELON . PI_DECSN ( F100JN2 ) , 1 , 1 ) ELSE ECHELON . PI_DECSN ( F100JN1 ) END AS F100JN12 
, CASE WHEN LENGTH ( TRIM ( F100JN2 ) ) > 0 THEN F100JN1 || '-' || SUBSTRING ( F100JN2 , 1 , 1 ) ELSE F100JN1 END AS F100JN12 
--, CASE WHEN LENGTH ( TRIM ( F100ETC ) ) > 0 THEN '/' || TRIM ( F100ETC ) ELSE '' END AS F100ETC 
, F100ETC 
, CASE WHEN F600CHR LIKE '%Positive%' THEN '양성' ELSE CASE WHEN F600CHR LIKE '%Inconclusive%' THEN '미결정' 
	ELSE	CASE WHEN F600CHR LIKE '%재검%' AND RE_TYPE = '528040' THEN '양성 재검' 
	ELSE	CASE WHEN F600CHR LIKE '%재검%' AND RE_TYPE = '528030' THEN 'Invalid 재검' 
	ELSE	CASE WHEN F600CHR LIKE '%재검%' AND RE_TYPE = '528050' THEN '미결정 재검' END END END END END AS GUBUN 
/*, CASE WHEN F600CHR LIKE '%Positive%' THEN '1' ELSE CASE WHEN F600CHR LIKE '%Inconclusive%' THEN '2' 
	ELSE	CASE WHEN F600CHR LIKE '%재검%' AND RE_TYPE = '528040' THEN '3' 
	ELSE	CASE WHEN F600CHR LIKE '%재검%' AND RE_TYPE = '528030' THEN '4' 
	ELSE	CASE WHEN F600CHR LIKE '%재검%' AND RE_TYPE = '528050' THEN '5' END END END END END AS GUBUNSEQ */ 
	, CASE WHEN F600CHR LIKE '%재검%' OR F600C04 <> '9' THEN '' ELSE IFNULL ( TRIM ( NCOVEGN ) , 'Negative' ) END AS EGN 
	, CASE WHEN F600CHR LIKE '%재검%' OR F600C04 <> '9' THEN '' ELSE IFNULL ( TRIM ( NCOVRGN ) , 'Negative' ) END AS RGN 
	, CASE WHEN F600CHR LIKE '%재검%' OR F600C04 <> '9' THEN '' ELSE IFNULL ( TRIM ( NCOVNGN ) , 'Negative' ) END AS NGN 
, F600CDT  -- 보고일자 (지점(남부,안양) - 요청으로 정렬을 위해 추가) 
, F600CTM  -- 보고시간 (지점(남부,안양) - 요청으로 정렬을 위해 추가) 
FROM MCLISDLIB . MC600M@ 
INNER JOIN MCLISDLIB . MC120M@ 
ON F600COR = F120COR 
AND F600HOS = F120PCD 
INNER JOIN MCLISDLIB . MC100H@ 
ON F600COR = F100COR 
AND F600DAT = F100DAT 
AND F600JNO = F100JNO 
LEFT OUTER JOIN ( SELECT * FROM ( 
SELECT ROW_NUMBER ( ) OVER ( PARTITION BY RECEPT_DATE , RECEPT_SEQUENCE ORDER BY REINS_DATE DESC , REINS_TIME DESC ) AS RN , RE . * FROM XCEEDIDLIB . CM_REINS RE ) RE 
WHERE RN = 1 ) 
ON F600COR = COMPANY 
AND F600DAT = RECEPT_DATE 
AND F600JNO = RECEPT_SEQUENCE 
LEFT OUTER JOIN MCLISDLIB . NCOVCT@ 
ON F600COR = NCOVCOR 
AND F600DAT = NCOVDAT 
AND F600JNO = NCOVJNO 
WHERE F600COR = $P_COR 
AND 
( 
	/***** 조건1) 연도가 같은경우 *****/ 
	F600DAT BETWEEN $P_FDAT AND ( CASE WHEN $P_TDAT > '20221231' 
THEN '20221231' 
ELSE $P_TDAT END ) 
	OR 
	/***** 조건1-1) 연도가 다른경우 + 2020년12월 포함인 경우 --> 2020년12월 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 6 ) < '202012' AND '202012' <= SUBSTRING ( $P_TDAT , 1 , 6 ) THEN '20001201' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 6 ) = '202012' AND '202012' <= SUBSTRING ( $P_TDAT , 1 , 6 ) THEN CONCAT ( '2000' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 6 ) <= '202012' AND '202012' < SUBSTRING ( $P_TDAT , 1 , 6 ) THEN '20001231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 6 ) <= '202012' AND '202012' = SUBSTRING ( $P_TDAT , 1 , 6 ) THEN CONCAT ( '2000' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건2) 연도가 다른경우 + 2021년 포함인 경우 --> 2027년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2021' AND '2021' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20270101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2021' AND '2021' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2027' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2021' AND '2021' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20271231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2021' AND '2021' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2027' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건3) 연도가 다른경우 + 2021년 포함인 경우 --> 2028년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2021' AND '2021' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20280101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2021' AND '2021' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2028' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2021' AND '2021' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20281231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2021' AND '2021' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2028' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건4) 연도가 다른경우 + 2021년 포함인 경우 --> 2029년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2021' AND '2021' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20290101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2021' AND '2021' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2029' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2021' AND '2021' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20291231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2021' AND '2021' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2029' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건5) 연도가 다른경우 + 2021년 포함인 경우 --> 2030년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2021' AND '2021' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20300101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2021' AND '2021' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2030' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2021' AND '2021' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20301231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2021' AND '2021' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2030' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건6) 연도가 다른경우 + 2022년 포함인 경우 --> 2023년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20230101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2023' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20231231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2023' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건7) 연도가 다른경우 + 2022년 포함인 경우 --> 2024년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20240101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2024' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20241231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2024' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건8) 연도가 다른경우 + 2022년 포함인 경우 --> 2025년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20250101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2025' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20251231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2025' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건9) 연도가 다른경우 + 2022년 포함인 경우 --> 2026년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20260101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2026' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20261231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2026' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건10) 연도가 다른경우 + 2022년 포함인 경우 --> 2037년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20370101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2037' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20371231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2037' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건11) 연도가 다른경우 + 2022년 포함인 경우 --> 2038년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20380101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2038' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20381231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2038' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건12) 연도가 다른경우 + 2022년 포함인 경우 --> 2039년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20390101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2039' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20391231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2039' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
) 
-- AND 
-- ( 
--     F600DAT BETWEEN $P_FDAT AND $P_TDAT OR F600DAT BETWEEN REPLACE ( REPLACE ( $P_FDAT , '2021' , '2029' ) , '202012' , '202912' ) AND REPLACE ( REPLACE ( $P_TDAT , '2021' , '2029' ) , '202012' , '202912' ) 
-- ) 
AND F600GCD IN ( '71330' , '71331' , '71334' , '71337' , '71338' , '71340' , '71341' , '71342' , '71346' , '71349' , '71350' , '71351' ) AND F600ACD IN ( '' , '01' ) 
AND ( F600CHR LIKE '%재검%' OR F600CHR LIKE '%Positive%' OR F600CHR LIKE '%Inconclusive%' ) 
AND ( F600HOS IN ( SELECT F999NM1 FROM MCLISDLIB . MC999D@ WHERE F999COR = $P_COR AND F999CD1 = 'CLIC' AND F999CD2 = 'SAA2' AND UPPER ( F999CD3 ) LIKE '' || UPPER ( $P_LOGID ) || '%' ) 
OR F600HOS = ( SELECT LOGHOS FROM MCLISDLIB . MCLOGI@ WHERE LOGCOR = $P_COR AND UPPER ( LOGLID ) = UPPER ( $P_LOGID ) ) ) 
ORDER BY F600HOS , F100DAT 
) 
--ORDER BY F600HOS , GUBUNSEQ, F600CDT, F600CTM ; 
ORDER BY F600CDT , F600CTM ; 
DECLARE CUR2 CURSOR FOR 
SELECT 
F600HOS AS HOSCD  --병원코드 
, F120FNM AS HOSNM  --병원명 
, GUBUN 
--, TRIM ( F100NAM ) || '(' || F100DAT || '/' || F100JN12 || F100ETC || ')' AS PATIENTNM 
, TRIM ( F100NAM ) AS NAM 
, TRIM ( SUBSTRING ( REPLACE ( REPLACE ( REPLACE ( REPLACE ( REPLACE ( REPLACE ( REPLACE ( REPLACE ( REPLACE ( REPLACE ( REPLACE ( REPLACE ( F100DAT , '2027' , '2021' ) , '2028' , '2021' ) , '2029' , '2021' ) , '2030' , '2021' ) , '2023' , '2022' ) , '2024' , '2022' ) , '2025' , '2022' ) , '2026' , '2022' ) , '2037' , '2022' ) , '2038' , '2022' ) , '2039' , '2022' ) , '2000' , '2020' ) , 1 , 4 ) || '-' || SUBSTRING ( F100DAT , 5 , 2 ) || '-' || SUBSTRING ( F100DAT , 7 , 2 ) ) AS DAT 
, TRIM ( F100JN12 ) AS JN12 
, TRIM ( F100ETC ) AS ETC 
, ( SELECT TRIM ( SUBSTRING ( S100PNO , 1 , 3 ) || '-' || SUBSTRING ( S100PNO , 4 , 4 ) || '-' || SUBSTRING ( S100PNO , 8 , 4 ) ) 
	FROM MCLISDLIB . MC100HSUB@ WHERE 1 = 1 
	AND S100COR = F100COR 
	AND S100DAT = F100DAT 
	AND S100JNO = F100JNO 
	AND S100HOS = F100HOS ) AS PNO 
, EGN  --E gene 
, RGN  --RdRP/S gene 
, NGN  --N gene 
, F600CDT  -- 보고일자 (지점(남부,안양) - 요청으로 정렬을 위해 추가) 
, F600CTM  -- 보고시간 (지점(남부,안양) - 요청으로 정렬을 위해 추가) 
, ( SELECT S100TMP10 
	FROM MCLISDLIB . MC100HSUB@ WHERE 1 = 1 
	AND S100COR = F100COR 
	AND S100DAT = F100DAT 
	AND S100JNO = F100JNO 
	AND S100HOS = F100HOS ) AS ADDRESS 
FROM 
( 
SELECT 
F100COR , F100JNO , F600HOS , F120FNM , F100NAM 
--, SUBSTRING ( F100DAT , 5 , 9 ) AS F100DAT 
, F100DAT , F100HOS 
-- 2022.01.06 복호화 제거 
--, CASE WHEN LENGTH ( TRIM ( F100JN2 ) ) > 0 THEN ECHELON . PI_DECSN ( F100JN1 ) || '-' || SUBSTRING ( ECHELON . PI_DECSN ( F100JN2 ) , 1 , 1 ) ELSE ECHELON . PI_DECSN ( F100JN1 ) END AS F100JN12 
, CASE WHEN LENGTH ( TRIM ( F100JN2 ) ) > 0 THEN F100JN1 || '-' || SUBSTRING ( F100JN2 , 1 , 1 ) ELSE F100JN1 END AS F100JN12 
--, CASE WHEN LENGTH ( TRIM ( F100ETC ) ) > 0 THEN '/' || TRIM ( F100ETC ) ELSE '' END AS F100ETC 
, F100ETC 
, CASE WHEN F600CHR LIKE '%Positive%' THEN '양성' ELSE CASE WHEN F600CHR LIKE '%Inconclusive%' THEN '미결정' 
	ELSE	CASE WHEN F600CHR LIKE '%재검%' AND RE_TYPE = '528040' THEN '양성 재검' 
	ELSE	CASE WHEN F600CHR LIKE '%재검%' AND RE_TYPE = '528030' THEN 'Invalid 재검' 
	ELSE	CASE WHEN F600CHR LIKE '%재검%' AND RE_TYPE = '528050' THEN '미결정 재검' END END END END END AS GUBUN 
/*, CASE WHEN F600CHR LIKE '%Positive%' THEN '1' ELSE CASE WHEN F600CHR LIKE '%Inconclusive%' THEN '2' 
	ELSE	CASE WHEN F600CHR LIKE '%재검%' AND RE_TYPE = '528040' THEN '3' 
	ELSE	CASE WHEN F600CHR LIKE '%재검%' AND RE_TYPE = '528030' THEN '4' 
	ELSE	CASE WHEN F600CHR LIKE '%재검%' AND RE_TYPE = '528050' THEN '5' END END END END END AS GUBUNSEQ */ 
	, CASE WHEN F600CHR LIKE '%재검%' OR F600C04 <> '9' THEN '' ELSE IFNULL ( TRIM ( NCOVEGN ) , 'Negative' ) END AS EGN 
	, CASE WHEN F600CHR LIKE '%재검%' OR F600C04 <> '9' THEN '' ELSE IFNULL ( TRIM ( NCOVRGN ) , 'Negative' ) END AS RGN 
	, CASE WHEN F600CHR LIKE '%재검%' OR F600C04 <> '9' THEN '' ELSE IFNULL ( TRIM ( NCOVNGN ) , 'Negative' ) END AS NGN 
, F600CDT  -- 보고일자 (지점(남부,안양) - 요청으로 정렬을 위해 추가) 
, F600CTM  -- 보고시간 (지점(남부,안양) - 요청으로 정렬을 위해 추가) 
FROM MCLISDLIB . MC600M@ 
INNER JOIN MCLISDLIB . MC120M@ 
ON F600COR = F120COR 
AND F600HOS = F120PCD 
INNER JOIN MCLISDLIB . MC100H@ 
ON F600COR = F100COR 
AND F600DAT = F100DAT 
AND F600JNO = F100JNO 
LEFT OUTER JOIN ( SELECT * FROM ( 
SELECT ROW_NUMBER ( ) OVER ( PARTITION BY RECEPT_DATE , RECEPT_SEQUENCE ORDER BY REINS_DATE DESC , REINS_TIME DESC ) AS RN , RE . * FROM XCEEDIDLIB . CM_REINS RE ) RE 
WHERE RN = 1 ) 
ON F600COR = COMPANY 
AND F600DAT = RECEPT_DATE 
AND F600JNO = RECEPT_SEQUENCE 
LEFT OUTER JOIN MCLISDLIB . NCOVCT@ 
ON F600COR = NCOVCOR 
AND F600DAT = NCOVDAT 
AND F600JNO = NCOVJNO 
WHERE F600COR = $P_COR 
AND 
( 
	/***** 조건1) 연도가 같은경우 *****/ 
	F600DAT BETWEEN $P_FDAT AND ( CASE WHEN $P_TDAT > '20221231' 
THEN '20221231' 
ELSE $P_TDAT END ) 
	OR 
	/***** 조건1-1) 연도가 다른경우 + 2020년12월 포함인 경우 --> 2020년12월 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 6 ) < '202012' AND '202012' <= SUBSTRING ( $P_TDAT , 1 , 6 ) THEN '20001201' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 6 ) = '202012' AND '202012' <= SUBSTRING ( $P_TDAT , 1 , 6 ) THEN CONCAT ( '2000' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 6 ) <= '202012' AND '202012' < SUBSTRING ( $P_TDAT , 1 , 6 ) THEN '20001231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 6 ) <= '202012' AND '202012' = SUBSTRING ( $P_TDAT , 1 , 6 ) THEN CONCAT ( '2000' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건2) 연도가 다른경우 + 2021년 포함인 경우 --> 2027년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2021' AND '2021' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20270101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2021' AND '2021' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2027' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2021' AND '2021' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20271231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2021' AND '2021' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2027' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건3) 연도가 다른경우 + 2021년 포함인 경우 --> 2028년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2021' AND '2021' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20280101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2021' AND '2021' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2028' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2021' AND '2021' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20281231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2021' AND '2021' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2028' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건4) 연도가 다른경우 + 2021년 포함인 경우 --> 2029년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2021' AND '2021' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20290101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2021' AND '2021' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2029' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2021' AND '2021' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20291231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2021' AND '2021' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2029' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건5) 연도가 다른경우 + 2021년 포함인 경우 --> 2030년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2021' AND '2021' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20300101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2021' AND '2021' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2030' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2021' AND '2021' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20301231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2021' AND '2021' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2030' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건6) 연도가 다른경우 + 2022년 포함인 경우 --> 2023년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20230101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2023' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20231231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2023' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건7) 연도가 다른경우 + 2022년 포함인 경우 --> 2024년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20240101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2024' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20241231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2024' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건8) 연도가 다른경우 + 2022년 포함인 경우 --> 2025년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20250101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2025' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20251231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2025' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건9) 연도가 다른경우 + 2022년 포함인 경우 --> 2026년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20260101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2026' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20261231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2026' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건10) 연도가 다른경우 + 2022년 포함인 경우 --> 2037년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20370101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2037' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20371231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2037' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건11) 연도가 다른경우 + 2022년 포함인 경우 --> 2038년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20380101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2038' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20381231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2038' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
	OR 
	/***** 조건12) 연도가 다른경우 + 2022년 포함인 경우 --> 2039년 *****/ 
	F600DAT BETWEEN ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) < '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20390101' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) = '2022' AND '2022' <= SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2039' , SUBSTRING ( $P_FDAT , 5 , 4 ) ) 
			ELSE $P_FDAT END 
	) AND ( 
		CASE WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' < SUBSTRING ( $P_TDAT , 1 , 4 ) THEN '20391231' 
			WHEN SUBSTRING ( $P_FDAT , 1 , 4 ) <= '2022' AND '2022' = SUBSTRING ( $P_TDAT , 1 , 4 ) THEN CONCAT ( '2039' , SUBSTRING ( $P_TDAT , 5 , 4 ) ) 
			ELSE $P_TDAT END 
	) 
) 
-- AND 
-- ( 
--     F600DAT BETWEEN $P_FDAT AND $P_TDAT 
--     OR F600DAT BETWEEN REPLACE ( REPLACE ( $P_FDAT , '2021' , '2029' ) , '202012' , '202912' ) AND REPLACE ( REPLACE ( $P_TDAT , '2021' , '2029' ) , '202012' , '202912' ) 
-- ) 
AND F600GCD IN ( '71330' , '71331' , '71334' , '71337' , '71338' , '71340' , '71341' , '71342' , '71346' , '71349' , '71350' , '71351' ) AND F600ACD IN ( '' , '01' ) 
AND ( F600CHR LIKE '%재검%' OR F600CHR LIKE '%Positive%' OR F600CHR LIKE '%Inconclusive%' ) 
AND F600HOS = $P_HOSCD 
ORDER BY F600HOS , F100DAT 
) 
--ORDER BY F600HOS , GUBUNSEQ, F600CDT, F600CTM ; 
ORDER BY F600CDT , F600CTM ; 
IF LENGTH ( TRIM ( $P_HOSCD ) ) = 5 THEN 
OPEN CUR2 ; 
SET RESULT SETS CURSOR CUR2 ;	 
ELSE 
OPEN CUR1 ; 
SET RESULT SETS CURSOR CUR1 ; 
END IF ; 
END  ; 
