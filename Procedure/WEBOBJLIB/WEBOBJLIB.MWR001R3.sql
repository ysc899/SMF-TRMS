--DROP PROCEDURE WEBOBJLIB.MWR001R3;

CREATE OR REPLACE PROCEDURE WEBOBJLIB.MWR001R3
(
	  IN I_COR 		VARCHAR(3) 	-- COR
	, IN I_UID 		VARCHAR(12) -- 사용자 ID
	, IN I_IP	  	VARCHAR(30)	-- 로그인 IP
	, OUT O_MSGCOD	CHAR(3)		-- 메세지 코드
	, OUT O_ERRCOD	CHAR(10)	-- 에러 코드		  
	, IN   I_FDT     DECIMAL(8,0)   --접수일자 FROM
	, IN   I_TDT     DECIMAL(8,0)   --접수일자 TO
	, IN   I_STS     VARCHAR(20)   --상태
	, IN   I_NAM     VARCHAR(100)   --수진자명
	, IN   I_CHN     VARCHAR(15)   --차트번호
	, IN   I_HOS   VARCHAR(5)   --병원
	, IN   I_REQDIV  VARCHAR(20)    -- 의뢰/접수일구분
)
LANGUAGE SQL
DYNAMIC RESULT SETS 1
BEGIN	
	--추가의뢰 정보  조회
   DECLARE CUR1  CURSOR WITH RETURN FOR
	SELECT
		  TRIM(M.R001COR) AS R001COR	 --회사코드
		, M.R001DAT AS R001DAT	 --접수일자
		, TRIM(M.R001DAT)  AS GRIDDAT	 --접수일자
		, M.R001JNO AS R001JNO	 --접수번호
		, TRIM(M.R001HOS) AS R001HOS	 --병원코드
		, TRIM(M.R001HNM) AS R001HNM	 --병원명
		-- 2022.01.06 복호화 제거
		--, ECHELON.PI_DECSN(M.R001CHN) AS R001CHN	 -- 차트번호
		, M.R001CHN AS R001CHN	 -- 차트번호
		, TRIM(M.R001NAM) AS R001NAM	 --환자명
		, TRIM(M.R001AGE) AS R001AGE	 -- 나이
		, TRIM(M.R001SEX) AS R001SEX	 --성별
        , LPAD(D.R001CDT,8,'0')|| LPAD(D.R001CTM,6,'0')  R001DTTM
		, (SELECT TRIM(S002CNM) 
			FROM WEBDBLIB.MWS002M@
			WHERE S002COR = M.R001COR 
			AND S002COR = I_COR
			AND S002PSCD='GENDER'
			AND S002SCD = M.R001SEX 
		     ) AS R001SEXNM
		, TRIM(M.R001CLT) R001CLT	 -- 검체채취일
		, TRIM(M.R001GDT) R001GDT	 -- 검체의뢰일
		, TRIM(D.R001STS) AS R001STS	 --상태
		, TRIM(R001GCD) AS R001GCD	 --검사코드 
		, TRIM(R001TCD) AS I_TCD	 --검체코드 
		, TRIM(R001TCD) AS R001TCD	 --검체코드 
		, TRIM(R001REJ)	 AS R001REJ	 --거부 사유 
		, TRIM(F010C01) AS F010C01 -- 지정검체 유무
		, IFNULL((SELECT TRIM(S002CNM) 
			FROM WEBDBLIB.MWS002M@
			WHERE S002COR =  M.R001COR 
			AND S002PSCD='REQ_STAT'
			AND S002SCD =   D.R001STS 
		    ),'') AS R001STSNM
		, IFNULL((SELECT TRIM(S002CNM) 
			FROM WEBDBLIB.MWS002M@
			WHERE S002COR = M.R001COR 
			AND S002PSCD='REJ_REASON'  
			AND S002SCD = R001REJ
			),'') AS R001REJNM
		, TRIM(F010FKN)F010FKN  -- 검사명(한글)
		, TRIM(F010TCD)  F010TCD   -- 검체 코드 (F999CD2 ='SAMP' )
		, (SELECT TRIM(MC9.F999NM2 )
		      FROM MCLISDLIB.MC999D@ MC9 
		      WHERE F999COR = F010COR 
			  AND F999CD1='CLIC' 
		      AND F999CD2 = 'SAMP' 
		      AND F999CD3 = F010TCD 
		) AS F010TNM
		, CASE WHEN F018OCD1  = '' THEN F018OCD2
		       WHEN  F018OCD2  = '' THEN F018OCD1
		       ELSE F018OCD1 ||', '||F018OCD2
		       END AS F018OCD	-- 보험코드
		, (SELECT F900KNM
		      FROM MCLISDLIB.MC120M@ MC120, JMTSLIB.MM900M@ MM900
		      WHERE F120COR = F900COR
		      AND F120DPT = F900DPT
			  AND F120PCD = TRIM(M.R001HOS) 
		) AS F900KNM -- 지점명
		FROM WEBDBLIB.MWR001M@ M, WEBDBLIB.MWR001D@ D
    LEFT JOIN (
       SELECT 
        CASE WHEN F018OCD1 != '' THEN  ' 서울 : '||TRIM(F018OCD1) ELSE '' END F018OCD1
       , CASE WHEN F018OCD2 != '' THEN  ' 부산 : '||TRIM(F018OCD2) ELSE '' END F018OCD2
       , F018GCD
       , F018COR
       FROM (
	    SELECT 
            IFNULL(MAX(F018OCD1),'')F018OCD1
            , IFNULL(MAX(F018OCD2),'')F018OCD2
            , F018GCD ,F018COR
            FROM (  
                SELECT 
                    CASE WHEN 
				TRIM(F018LMB)   = ''	--서울 보험코드
				THEN TRIM(F018OCD) 
                      END F018OCD1
	                 , CASE WHEN 
				TRIM(F018LMB)   ='6526'	-- 부산 보험코드
				THEN TRIM(F018OCD)
	                  END F018OCD2
	                 , TRIM(F018GCD) AS F018GCD
	                 , F018COR
                    FROM MCLISDLIB.MC018M@ A
                    WHERE F018COR = 'NML'
                    AND F018OSD =  
                    	(SELECT MAX(F018OSD) 
                         FROM  MCLISDLIB.MC018M@ B
                         WHERE A.F018COR = B.F018COR
                         AND A.F018GCD = B.F018GCD)
                    ) A
                    GROUP BY F018GCD,F018COR
                ) A
            ) B ON  B.F018COR = D.R001COR 
	    	AND B.F018GCD = D.R001GCD	--검사코드
	 , MCLISDLIB.MC010M@
	WHERE F010COR = D.R001COR
	AND F010GCD = R001GCD
	AND M.R001COR = D.R001COR
	AND M.R001COR = I_COR
	AND M.R001DAT = D.R001DAT
	AND M.R001JNO = D.R001JNO
    AND(( I_REQDIV = 'D' AND M.R001DAT BETWEEN I_FDT AND I_TDT)--접수일자
		  OR( I_REQDIV = 'C'  AND D.R001CDT BETWEEN I_FDT AND I_TDT) --의뢰일자
		)
	AND (I_NAM = '' OR  M.R001NAM  LIKE '%'||I_NAM||'%') --환자명
	--AND (I_CHN = '' OR  ECHELON.PI_DECSN(R001CHN)  LIKE I_CHN||'%') --차트번호
	AND (I_CHN = '' OR  R001CHN LIKE I_CHN||'%') --차트번호
	AND (I_HOS = '' OR  R001HOS  = I_HOS) --병원코드
	AND (I_STS = '' OR  D.R001STS  = I_STS) --상태
	ORDER BY M.R001COR,  M.R001DAT DESC, M.R001JNO DESC,  M.R001HOS,M.R001CHN
	;
			
	OPEN CUR1;
	SET O_MSGCOD = '200';
END