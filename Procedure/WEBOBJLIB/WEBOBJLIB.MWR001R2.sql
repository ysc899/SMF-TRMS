--DROP PROCEDURE WEBOBJLIB.MWR001R2;

CREATE OR REPLACE PROCEDURE WEBOBJLIB.MWR001R2_TEST
(
	  IN I_COR 		VARCHAR(3) 	-- COR
	, IN I_UID 		VARCHAR(12) -- 사용자 ID
	, IN I_IP	  	VARCHAR(30)	-- 로그인 IP
	, OUT O_MSGCOD	CHAR(3)		-- 메세지 코드
	, OUT O_ERRCOD	CHAR(10)	-- 에러 코드
	, IN   I_DAT         DECIMAL(8,0)  --접수일자
	, IN   I_JNO         DECIMAL(5,0)   --접수번호
)
LANGUAGE SQL
DYNAMIC RESULT SETS 1
BEGIN	
	--추가의뢰 정보  조회
    DECLARE CUR1  CURSOR WITH RETURN FOR
	
		SELECT 
			TRIM(R001COR) AS R001COR	--회사코드 
			, TRIM(R001DAT) AS R001DAT	--접수일자 
			, TRIM(R001DAT) AS GRIDDAT	--접수일자 
			, TRIM(R001JNO) AS R001JNO	--접수번호 
			, TRIM(R001GCD) AS R001GCD	--검사코드 
			, TRIM(R001TCD) AS I_TCD	--검체코드 
			, TRIM(R001TCD) AS R001TCD	--검체코드 
			, TRIM(R001REJ) AS R001REJ	--거부 사유 
			, TRIM(F010C01) AS F010C01	-- 지정검체 유무
			, (SELECT TRIM(S002CNM) 
				FROM WEBDBLIB.MWS002M@
				WHERE S002COR = R001COR 
				AND S002PSCD='REJ_REASON'  
				AND S002SCD = R001REJ
				) AS R001REJNM
			, TRIM(R001STS) AS R001STS	 --상태 
			, (SELECT TRIM(S002CNM) 
				FROM WEBDBLIB.MWS002M@
				WHERE S002COR = R001COR 
				AND S002PSCD='REQ_STAT'  
				AND S002SCD = R001STS
				) AS R001STSNM
			,TRIM(F010FKN)F010FKN	-- 검사명(한글)
			,TRIM(F010TCD)  F010TCD	-- 검체 코드 (F999CD2 ='SAMP' )
			,(SELECT TRIM(MC9.F999NM2 )
				  FROM MCLISDLIB.MC999D@ MC9 
				  WHERE F999COR = F010COR 
				  AND F999CD1='CLIC' 
				  AND F999CD2 = 'SAMP' 
				  AND F999CD3 = F010TCD 
				) AS F010TNM
			, (SELECT (CASE WHEN TRIM(RR.F018LMB) = '' THEN '서울 : '
							WHEN TRIM(RR.F018LMB) = '6526' THEN '부산 : '
							WHEN TRIM(RR.F018LMB) = '6520' THEN '대구 : '
							WHEN TRIM(RR.F018LMB) = '6540' THEN '광주 : '
							ELSE '' END) || TRIM(RR.F018OCD) 
				FROM MCLISDLIB."MC018M@" RR
				WHERE 1=1
				AND RR.F018COR = A.R001COR
				AND RR.F018GCD = A.R001GCD
				AND RR.F018LMB = COALESCE(
									(SELECT 
										(CASE WHEN count(f600cno) < 1 THEN '9999' ELSE f600cno END)
										FROM MCLISDLIB."MC600M@" BB
										WHERE 1=1
										AND BB.F600COR = A.R001COR
										AND BB.F600DAT = A.R001DAT
										AND BB.F600JNO = A.R001JNO
										AND BB.F600GCD = A.R001GCD
										GROUP BY f600cno
										FETCH FIRST 1 ROWS ONLY
									),'9999')
				ORDER BY F018OSD DESC
				FETCH FIRST 1 ROWS ONLY
				) F018OCD	-- 보험코드
		   , LPAD(A.R001CDT,8,'0')|| LPAD(A.R001CTM,6,'0')  R001DTTM
		FROM WEBDBLIB.MWR001D@ A
		LEFT JOIN MCLISDLIB."MC010M@" D
		ON D.F010COR = A.R001COR
		AND D.F010GCD = A.R001GCD
		WHERE 1=1
		AND R001COR = I_COR
		AND R001DAT = I_DAT     -- 접수일자
		AND R001JNO  = I_JNO --병원코드
    	;
    OPEN CUR1;
    SET O_MSGCOD = '200';

END


