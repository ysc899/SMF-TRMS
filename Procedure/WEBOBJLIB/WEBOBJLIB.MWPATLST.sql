--DROP PROCEDURE WEBOBJLIB.MWPATLST;

CREATE OR REPLACE PROCEDURE WEBOBJLIB.MWPATLST
(
     IN I_COR       VARCHAR(3)     -- COR  
   , IN I_UID       VARCHAR(12)    -- 사용자 ID
   , IN I_IP      VARCHAR(30)      -- 사용자 IP
   , OUT O_MSGCOD   VARCHAR(3)     -- 메세지 코드
   , OUT O_ERRCOD   VARCHAR(10)    -- 에러 코드  
   , IN I_HOS      VARCHAR(5)      -- 병원 코드
   , IN I_CHN      VARCHAR(15)     -- 차트 번호 
   , IN I_NAM      VARCHAR(30)     -- 수진자명 
)
LANGUAGE SQL
DYNAMIC RESULT SETS 1
BEGIN
	-- 수진자 검색 팝업, 수진자 정보 호출
DECLARE CUR1 CURSOR WITH RETURN FOR 
		SELECT
			TRIM ( F100COR ) F100COR
			, TRIM ( F100HOS ) F100HOS
			, TRIM ( F100NAM ) F100NAM
			, TRIM ( F100SEX ) F100SEX
			, TRIM ( F100BDT ) F100BDT
			, MAX ( F100DAT ) F100DAT
			, MAX ( F100AGE ) F100AGE
			, TRIM ( F100CHN ) F100CHN
			-- 2022.01.06 복호화 제거
			--, ECHELON.PI_DECSN ( F100CHN ) F100C
			, F100CHN AS F100C
			, ( SELECT F120FNM
				FROM MCLISDLIB.MC120M@
				WHERE F120COR = F100COR
				AND F120COR = I_COR
				AND F120PCD = F100HOS ) F120FNM
		FROM(
			SELECT
				TRIM ( F100COR ) F100COR
				, TRIM ( F100HOS ) F100HOS
				, TRIM ( F100NAM ) F100NAM
				, TRIM ( F100SEX ) F100SEX
				, TRIM ( F100BDT ) F100BDT
				, TRIM ( F100DAT ) F100DAT
				, TRIM ( F100AGE ) F100AGE
				, TRIM ( F100CHN ) F100CHN
			FROM MCLISDLIB.MC100H@ A
			WHERE F100COR = I_COR 
			--AND F100DAT BETWEEN 20100101 AND 20190228
			AND F100HOS = I_HOS
		    AND A.F100DAT > 0
		    AND A.F100JNO > 0    
			AND F100BDT > 0
			AND F100CHN <> ''
			--AND ECHELON . PI_DECSN ( F100CHN ) LIKE I_CHN || '%'
			AND F100CHN LIKE I_CHN || '%'
			AND F100NAM LIKE I_NAM || '%'
		) A
		GROUP BY F100COR , F100HOS , F100NAM , F100SEX , F100BDT , F100CHN
		ORDER BY F100COR , F100HOS , F100NAM  ,F100DAT DESC;

   OPEN CUR1; 
   
   SET O_MSGCOD = '200';
   SET O_ERRCOD = '';
   
END