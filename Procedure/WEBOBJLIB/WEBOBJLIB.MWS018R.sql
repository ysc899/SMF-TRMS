DROP PROCEDURE WEBOBJLIB.MWS018R;

CREATE PROCEDURE WEBOBJLIB.MWS018R
(
	  IN I_COR 		VARCHAR(3) 	-- COR
	, IN I_UID 		VARCHAR(12) -- 사용자 ID
	, IN I_IP	  	VARCHAR(30)	-- 로그인 IP
	, OUT O_MSGCOD	CHAR(3)	-- 메세지 코드
	, OUT O_ERRCOD	CHAR(10)	 -- 에러 코드
	, IN  I_RCL		VARCHAR(20)	 -- 양식지
	, IN  I_RTP		VARCHAR(20)	  -- 결과지 타입
	, IN  I_RFM		VARCHAR(20)	  -- 폼
	, IN  I_GCD		VARCHAR(5)	  -- 검사코드
	, IN  I_FKN		VARCHAR(50)	  --검사항목
	, IN  I_STS		VARCHAR(1)	  --검사사용여부
)
LANGUAGE SQL
DYNAMIC RESULT SETS 1
BEGIN	
	-- 항목별 결과 양식 관리 조회
   DECLARE CUR1  CURSOR WITH RETURN FOR
   SELECT
	   X.S011RCL, X.S011RTP, X.S011RFM
		, (SELECT TRIM(S002CNM) 
			FROM WEBDBLIB.MWS002M@ 
			WHERE S002COR = F010COR 
			AND S002PSCD='RPT_FORM'  
			AND S002SCD = S011RFM 
			) AS RFMNM
		, (SELECT TRIM(S002CNM) 
			FROM WEBDBLIB.MWS002M@ 
			WHERE S002COR = F010COR 
			AND S002PSCD='RPT_CLS'  
			AND S002SCD = S011RCL 
			) AS RCLNM
		, (SELECT TRIM(S002CNM) 
			FROM WEBDBLIB.MWS002M@ 
			WHERE S002COR = F010COR 
			AND S002PSCD='RPT_TYPE'  
			AND S002SCD = S011RTP 
			) AS RTPNM
	   , TRIM(X.F010GCD) AS I_GCD
	   , TRIM(X.F010GCD) AS F010GCD
	   , TRIM(X.F010FKN) AS F010FKN
	   , TRIM(X.F010COR) AS F010COR
	   , TRIM(Y.S018TIT) AS S018TIT
	   , TRIM(Y.S018RGN) AS S018RGN
	   , TRIM(Y.S018RFN) AS S018RFN	--리포트 파일
	   , IFNULL(Y.S018SYN,'N') AS S018SYN	--단일 출력 여부
	   , TRIM(IFNULL(Y.S018TIT,'')) AS I_TIT
	   , TRIM(IFNULL(Y.S018RGN,'')) AS I_RGN
	   , TRIM(IFNULL(Y.S018RFN,'')) AS I_RFN	--리포트 파일
	   , IFNULL(Y.S018SYN,'N')  AS I_SYN	--단일 출력 여부
	   , X.F010STS AS  F010STS	--사용여부
FROM(
   SELECT
	      B.S011RCL, B.S011RTP, B.S011RFM
	      , A.F010GCD, A.F010FKN , A.F010COR,A.F010STS 
	   FROM MCLISDLIB.MC010M@ A, WEBDBLIB.MWS011M@ B
	   WHERE A.F010COR = B.S011COR
	   AND   A.F010RNO = B.S011RFM
	   AND   A.F010COR = I_COR 
	   AND (I_STS = '' OR	A.F010STS = I_STS)	--검사사용여부
	   AND (I_RFM = '' OR	B.S011RFM = I_RFM)	--폼
	   AND (I_RCL = '' OR	B.S011RCL = I_RCL)	--양식지
	   AND (I_RTP = '' OR	B.S011RTP = I_RTP)	--결과지타입
	   AND (I_GCD = '' OR A.F010GCD LIKE	I_GCD ||'%')	--검사코드
	   AND (I_FKN = '' OR	A.F010FKN LIKE '%' || I_FKN ||'%')	--검사항목
)X LEFT OUTER JOIN WEBDBLIB.MWS018M@ Y 
	ON X.F010COR = Y.S018COR AND X.F010GCD = Y.S018GCD
	ORDER BY X.S011RCL, X.S011RTP, X.S011RFM, X.F010GCD
   ;

	SET O_MSGCOD = '200';
   OPEN CUR1;
END