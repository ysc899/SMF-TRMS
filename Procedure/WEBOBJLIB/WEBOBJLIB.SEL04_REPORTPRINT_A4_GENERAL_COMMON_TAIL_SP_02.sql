--  Generate SQL 
--  Version:                   V7R2M0 140418 
--  Generated on:              20/11/11 14:49:08 
--  Relational Database:       NEODIN 
--  Standards Option:          DB2 for i 
DROP SPECIFIC PROCEDURE WEBOBJLIB.SEL04_REPORTPRINT_A4_GENERAL_COMMON_TAIL_SP_02 ; 
SET PATH "QSYS","QSYS2","SYSPROC","SYSIBMADM","NEO014" ; 
CREATE OR REPLACE PROCEDURE WEBOBJLIB.SEL04_REPORTPRINT_A4_GENERAL_COMMON_TAIL_SP_02 ( 
  IN $P_COR CHAR(3) , 
  IN $P_DAT VARCHAR(8) , 
  IN $P_JNO VARCHAR(5) , 
  IN $P_FNO CHAR(2) ) 
  DYNAMIC RESULT SETS 2 
  LANGUAGE SQL 
  SPECIFIC WEBOBJLIB.SEL04_REPORTPRINT_A4_GENERAL_COMMON_TAIL_SP_02 
  NOT DETERMINISTIC 
  READS SQL DATA 
  CALLED ON NULL INPUT 
  SET OPTION  ALWBLK = *ALLREAD , 
  ALWCPYDTA = *OPTIMIZE , 
  COMMIT = *NONE , 
  DBGVIEW = *SOURCE , 
  DECRESULT = (31, 31, 00) , 
  DFTRDBCOL = *NONE , 
  DLYPRP = *NO , 
  DYNDFTCOL = *NO , 
  DYNUSRPRF = *USER , 
  SRTSEQ = *HEX 
  BEGIN 
--/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 
--////////////////////////////////////////////// 실제 검사한 센터(재위탁 센터) /////////////////////////////////////////////////////// 
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// 
DECLARE CUR_TEST CURSOR WITH RETURN TO CALLER FOR 
WITH TARGET_LMB AS 
( 
	SELECT HOSPITAL , LMB FROM ( 
		SELECT ROW_NUMBER ( ) OVER ( PARTITION BY HOSPITAL ORDER BY ACCESS_DATE DESC ) AS ROW_NUM , HOSPITAL , LMB 
		FROM MCLISDLIB . MCHOSLMBH@ 
		WHERE COMPANY = $P_COR 
	AND ACCESS_DATE <= $P_DAT 
	) WHERE ROW_NUM = 1 
) 
, TARGET_057 AS ( 
	SELECT F057LAB 
			, F057HAK 
			, F057NM1 
			, F057NO1 
			, F057NM3 
			, F057NO3 
			, F057NM5 
			, F057NO5 
			, F057NM7 
			, F057NO7 
			, F057KLM 
			, F057ORG 
			, F057ADR 
			, F057TEL 
			, F057FAX 
	FROM ( 
		SELECT 
		ROW_NUMBER ( ) OVER ( PARTITION BY F057LAB , F057HAK ORDER BY F057OSD DESC ) AS ROW_NUM 
		, F057LAB , F057HAK , F057NM1 , F057NO1 , F057NM3 , F057NO3 , F057NM5 , F057NO5 , F057NM7 , F057NO7 , F057KLM , F057ORG , F057ADR , F057TEL , F057FAX 
		FROM MCLISDLIB . MC057M@ 
		WHERE F057COR = $P_COR 
		AND F057OSD <= $P_DAT 
		GROUP BY F057LAB , F057HAK , F057OSD , F057NM1 , F057NO1 , F057NM3 , F057NO3 , F057NM5 , F057NO5 , F057NM7 , F057NO7 , F057KLM , F057ORG , F057ADR , F057TEL , F057FAX 
		) WHERE ROW_NUM = 1 
) 
SELECT 
LISTAGG ( TRIM ( TEST_CHARGE_DR_NM ) , ',' ) AS TEST_CHARGE_DR_NM 
, LISTAGG ( TRIM ( TEST_CHARGE_DR_NO ) , ',' ) AS TEST_CHARGE_DR_NO 
, LISTAGG ( TRIM ( TEST_CENTER_INFO ) , ',' ) AS TEST_CENTER_INFO 
, LISTAGG ( TRIM ( TEST_CENTER_INFO_NM ) , ',' ) AS TEST_CENTER_INFO_NM 
FROM ( 
	SELECT DISTINCT 
		CASE WHEN TEST_CENTER . F057LAB IS NULL THEN TEST_CENTER_0000 . F057NM3 ELSE TEST_CENTER . F057NM3 END AS TEST_CHARGE_DR_NM 
		, CASE WHEN TEST_CENTER . F057LAB IS NULL THEN TEST_CENTER_0000 . F057NO3 ELSE TEST_CENTER . F057NO3 END AS TEST_CHARGE_DR_NO 
		, CASE WHEN TEST_CENTER . F057LAB IS NULL 
THEN TRIM ( TEST_CENTER_0000 . F057ORG ) || ' ' || TRIM ( TEST_CENTER_0000 . F057KLM ) 
		ELSE TRIM ( TEST_CENTER . F057ORG ) || ' ' || TRIM ( TEST_CENTER . F057KLM ) 
END AS TEST_CENTER_INFO 
, CASE WHEN TEST_CENTER . F057LAB IS NULL 
THEN TRIM ( TEST_CENTER_0000 . F057KLM ) 
		ELSE TRIM ( TEST_CENTER . F057KLM ) 
END AS TEST_CENTER_INFO_NM 
	FROM MCLISDLIB . MC100H@ 
	INNER JOIN MCLISDLIB . MC600M@ 
	ON F100COR = F600COR 
	AND F100DAT = F600DAT 
	AND F100JNO = F600JNO 
	INNER JOIN JMTSLIB . MM910M@ AS SALES 
	ON F910COR = F100COR 
	AND F910SAB = F100MBC 
	INNER JOIN TARGET_LMB 
	ON F100HOS = HOSPITAL 
	LEFT JOIN TARGET_057 AS TEST_CENTER 
	ON TEST_CENTER . F057LAB = F600CNO 
	AND TEST_CENTER . F057LAB <> LMB 
	AND TEST_CENTER . F057HAK = F600HAK 
	LEFT JOIN TARGET_057 AS TEST_CENTER_0000 
	ON TEST_CENTER_0000 . F057LAB = F600CNO 
	AND TEST_CENTER_0000 . F057LAB <> LMB 
	AND TEST_CENTER_0000 . F057HAK = '0000' 
	WHERE F100COR = $P_COR 
	AND F100DAT = $P_DAT 
	AND F100JNO = $P_JNO 
	AND ( TEST_CENTER . F057LAB IS NOT NULL OR TEST_CENTER_0000 . F057LAB IS NOT NULL ) 
	AND F600C03 = 'Y' 
) AS GROUPING_DATA 
; 
OPEN CUR_TEST ; 
END  ; 
