--DROP SPECIFIC PROCEDURE WEBOBJLIB.SEL_CORONA_RESULT_IMG_SERCH_QR; 

CREATE OR REPLACE PROCEDURE WEBOBJLIB.SEL_CORONA_RESULT_IMG_SERCH_QR( 
	  IN $I_HOS VARCHAR(5) , 
	  IN $I_DAT VARCHAR(8) , 
	  IN $I_JNO VARCHAR(5) , 
	  IN $I_SIGN VARCHAR(100) 
  )  
  LANGUAGE SQL
DYNAMIC RESULT SETS 1
BEGIN 
	
	 
	IF $I_SIGN <> '' THEN 
BEGIN 
DECLARE CUR1 CURSOR WITH RETURN FOR 
		SELECT BB . S100DAT ,	 -- 접수일자 
			BB . S100JNO ,	 -- 접수번호 
			AA . F600GCD ,	 -- 검사코드 
			GG . F100NAM ,	 -- 환자명 
			BB . S100PNO ,	 -- 연락처 
			GG . F100BDT ,	 -- 생년월일 
			BB . S100HOS	 -- 병원코드 
		FROM MCLISDLIB . MC100HSUB@ BB  -- 핸드폰번호가 등록된 병원만 SMS 발송을 할수 있게 하기 위한 JOIN 
		inner JOIN MCLISDLIB . "MC600M@" AA 
			ON AA . F600COR = BB . S100COR 
			AND AA . F600DAT = BB . S100DAT 
			AND AA . F600JNO = BB . S100JNO 
			AND AA . F600HOS = BB . S100HOS 
		inner JOIN MCLISDLIB . MC100H@ GG 
			ON GG . F100COR = BB . S100COR 
			AND GG . F100DAT = BB . S100DAT 
			AND GG . F100JNO = BB . S100JNO 
			AND GG . F100HOS = BB . S100HOS 
		WHERE 1 = 1 
		AND BB . S100COR = 'NML' 
		AND BB . S100HOS = (CASE WHEN $I_HOS = '' THEN BB.S100HOS ELSE $I_HOS END)
		AND BB . S100TMP8 = $I_SIGN; 
OPEN CUR1 ; 
END ; 
	ELSE 
BEGIN 
DECLARE CUR2 CURSOR WITH RETURN FOR 
		SELECT AA . F600DAT AS S100DAT ,	 -- 접수일자 
			AA . F600JNO AS S100JNO ,	 -- 접수번호 
			AA . F600GCD ,	 -- 검사코드 
			GG . F100NAM ,	 -- 환자명 
			GG . F100BDT	 -- 생년월일 
		FROM MCLISDLIB . "MC600M@" AA 
		LEFT JOIN MCLISDLIB . MC100H@ GG 
			ON AA . F600COR = GG . F100COR 
			AND AA . F600DAT = GG . F100DAT 
			AND AA . F600JNO = GG . F100JNO 
			AND AA . F600HOS = GG . F100HOS 
		WHERE 1 = 1 
		AND AA . F600COR = 'NML' 
		AND AA . F600DAT = $I_DAT 
		AND AA . F600JNO = $I_JNO 
		AND AA . F600HOS = (CASE WHEN '' = '' THEN AA.F600HOS ELSE '' END); 
OPEN CUR2 ; 
END ; 
	END IF ; 
END  ; 