--DROP PROCEDURE WEBOBJLIB.MRIMGMPR1;

CREATE OR REPLACE PROCEDURE WEBOBJLIB.MRIMGMPR1 (IN I_COR VARCHAR(3)
									  , IN I_UID VARCHAR(12)
									  , IN I_IP  VARCHAR(30)
									  , OUT O_MSGCOD VARCHAR(3)
									  , OUT O_ERRCOD VARCHAR(10)
									  , IN I_DAT VARCHAR(8)
									  , IN I_JNO VARCHAR(5)
									  , IN I_HOS VARCHAR(5))
LANGUAGE SQL
DYNAMIC RESULT SETS 1
  BEGIN 
	 --오더의뢰지 리스트 조회 
	DECLARE C1 CURSOR WITH RETURN FOR 
		SELECT COMPANY 
			, DATE 
			, HOSPITAL_CODE 
			, SEQUENCE 
			, SEND_USER_ID USER_ID 
			, '' UUID 
			, '' I_IMG 
			, '' FILENM 
			, '' FILEPAH 
			, 'm' FLAG 
		FROM MRECLIB . MRIMGMP 
		WHERE ( COMPANY , HOSPITAL_CODE , DATE , SEQUENCE ) IN ( 
		SELECT COMPANY 
			, HOSPITAL_CODE 
			, DATE 
			, SEQUENCE 
		FROM MRECLIB . MRWRKMMP 
		WHERE COMPANY = I_COR 
		 --AND date = I_DAT 
		AND DATE = ( CASE SUBSTRING ( I_DAT , 1 , 4 ) 
						WHEN '2023' THEN ( CASE SUBSTRING ( I_DAT , 5 , 2 ) 
											WHEN '12' THEN REPLACE ( I_DAT , '2000' , '2020' ) 
											ELSE I_DAT 
										END ) 
						WHEN '2027' THEN REPLACE ( I_DAT , '2027' , '2021' ) 
						WHEN '2028' THEN REPLACE ( I_DAT , '2028' , '2021' ) 
						WHEN '2029' THEN REPLACE ( I_DAT , '2029' , '2021' ) 
						WHEN '2030' THEN REPLACE ( I_DAT , '2030' , '2021' ) 
						WHEN '2023' THEN REPLACE ( I_DAT , '2023' , '2022' ) 
						WHEN '2024' THEN REPLACE ( I_DAT , '2024' , '2022' ) 
						WHEN '2025' THEN REPLACE ( I_DAT , '2025' , '2022' ) 
						WHEN '2026' THEN REPLACE ( I_DAT , '2026' , '2022' )
						WHEN '2037' THEN REPLACE ( I_DAT , '2037' , '2022' )
						WHEN '2038' THEN REPLACE ( I_DAT , '2038' , '2022' )
						WHEN '2039' THEN REPLACE ( I_DAT , '2039' , '2022' )
						ELSE I_DAT 
					END ) 
		AND RECEIPT_NO = I_JNO 
		AND HOSPITAL_CODE = I_HOS 
		UNION 
		SELECT COMPANY 
			, HOSPITAL_CODE 
			, DATE 
			, SEQUENCE 
		FROM MRECLIB . MRWRKMP 
		WHERE COMPANY = I_COR 
		 --AND date = I_DAT 
		AND DATE = ( CASE SUBSTRING ( I_DAT , 1 , 4 ) 
						WHEN '2023' THEN ( CASE SUBSTRING ( I_DAT , 5 , 2 ) 
											WHEN '12' THEN REPLACE ( I_DAT , '2000' , '2020' ) 
											ELSE I_DAT 
										END ) 
						WHEN '2027' THEN REPLACE ( I_DAT , '2027' , '2021' ) 
						WHEN '2028' THEN REPLACE ( I_DAT , '2028' , '2021' ) 
						WHEN '2029' THEN REPLACE ( I_DAT , '2029' , '2021' ) 
						WHEN '2030' THEN REPLACE ( I_DAT , '2030' , '2021' ) 
						WHEN '2023' THEN REPLACE ( I_DAT , '2023' , '2022' ) 
						WHEN '2024' THEN REPLACE ( I_DAT , '2024' , '2022' ) 
						WHEN '2025' THEN REPLACE ( I_DAT , '2025' , '2022' ) 
						WHEN '2026' THEN REPLACE ( I_DAT , '2026' , '2022' ) 
						WHEN '2037' THEN REPLACE ( I_DAT , '2037' , '2022' ) 
						WHEN '2038' THEN REPLACE ( I_DAT , '2038' , '2022' ) 
						WHEN '2039' THEN REPLACE ( I_DAT , '2039' , '2022' ) 
						ELSE I_DAT 
					END ) 
		AND RECEIPT_NO = I_JNO 
		AND HOSPITAL_CODE = I_HOS 
		) 
		UNION ALL 
		SELECT COMPANY 
			, SUBSTR ( RECEPT_DATE , 0 , 9 ) DATE 
			, HOSPITAL_CODE 
			, SEQUENCE 
			, SEND_USER USER_ID 
			, '' UUID 
			, '' I_IMG 
			, '' FILENM 
			, '' FILEPAH 
			, 's' FLAG 
		FROM MRECLIB . XEROX_IMG 
		WHERE COMPANY = I_COR 
		 --AND SUBSTR(RECEPT_DATE,0,9) = I_DAT 
		AND SUBSTR ( RECEPT_DATE , 0 , 9 ) = ( CASE SUBSTRING ( I_DAT , 1 , 4 ) 
						WHEN '2023' THEN ( CASE SUBSTRING ( I_DAT , 5 , 2 ) 
											WHEN '12' THEN REPLACE ( I_DAT , '2000' , '2020' ) 
											ELSE I_DAT 
										END ) 
						WHEN '2027' THEN REPLACE ( I_DAT , '2027' , '2021' ) 
						WHEN '2028' THEN REPLACE ( I_DAT , '2028' , '2021' ) 
						WHEN '2029' THEN REPLACE ( I_DAT , '2029' , '2021' ) 
						WHEN '2030' THEN REPLACE ( I_DAT , '2030' , '2021' ) 
						WHEN '2023' THEN REPLACE ( I_DAT , '2023' , '2022' ) 
						WHEN '2024' THEN REPLACE ( I_DAT , '2024' , '2022' ) 
						WHEN '2025' THEN REPLACE ( I_DAT , '2025' , '2022' ) 
						WHEN '2026' THEN REPLACE ( I_DAT , '2026' , '2022' ) 
						WHEN '2037' THEN REPLACE ( I_DAT , '2037' , '2022' ) 
						WHEN '2038' THEN REPLACE ( I_DAT , '2038' , '2022' ) 
						WHEN '2039' THEN REPLACE ( I_DAT , '2039' , '2022' ) 
						ELSE I_DAT 
					END ) 
		AND RECEPT_SEQUENCE = I_JNO 
		AND HOSPITAL_CODE = I_HOS 
		ORDER BY SEQUENCE ASC ; 
	SET O_ERRCOD = '' ; 
	SET O_MSGCOD = 200 ; 
	OPEN C1 ; 
END  ; 