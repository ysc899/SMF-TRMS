--DROP PROCEDURE WEBOBJLIB.MWR001R1;

CREATE OR REPLACE PROCEDURE WEBOBJLIB.MWR001R1
(
	  IN I_COR 		VARCHAR(3) 	-- COR
	, IN I_UID 		VARCHAR(12) -- 사용자 ID
	, IN I_IP	  	VARCHAR(30)	-- 로그인 IP
	, OUT O_MSGCOD	CHAR(3)		-- 메세지 코드
	, OUT O_ERRCOD	CHAR(10)	-- 에러 코드		  
	, IN   I_FDT     DECIMAL(8,0)   --접수일자 FROM
	, IN   I_TDT     DECIMAL(8,0)   --접수일자 TO
	, IN   I_STS     VARCHAR(20)   --상태
	, IN   I_NAM     VARCHAR(100)   --수진자명
	, IN   I_CHN     VARCHAR(15)   --차트번호
	, IN   I_HOS   VARCHAR(5)   --병원
	, IN   I_REQDIV     VARCHAR(20)  -- 의뢰/접수일구분
)
LANGUAGE SQL
DYNAMIC RESULT SETS 1
BEGIN	
	--추가의뢰 정보  조회
   DECLARE CUR1  CURSOR WITH RETURN FOR
	SELECT
		  TRIM(R001COR) AS R001COR	 --회사코드
		, R001DAT AS R001DAT	 --접수일자
		, TRIM(R001DAT)  AS GRIDDAT	 --접수일자
		, R001JNO AS R001JNO	 --접수번호
		, TRIM(R001HOS) AS R001HOS	 --병원코드
		, TRIM(R001HNM) AS R001HNM	 --병원명
		--, ECHELON.PI_DECSN(R001CHN) AS R001CHN	 -- 차트번호
		, R001CHN	 -- 차트번호
		, TRIM(R001NAM) AS R001NAM	 --환자명
		, TRIM(R001AGE) AS R001AGE	 -- 나이
		, TRIM(R001SEX) AS R001SEX	 --성별
		, (SELECT TRIM(S002CNM) 
			FROM WEBDBLIB.MWS002M@
			WHERE S002COR = R001COR 
			AND S002COR = I_COR
			AND S002PSCD='GENDER'
			AND S002SCD = R001SEX 
		     ) AS R001SEXNM
		, TRIM(R001CLT) R001CLT	 -- 검체채취일
		, TRIM(R001GDT) R001GDT	 -- 검체의뢰일
		, TRIM(R001STS) AS R001STS	 --상태
		, (SELECT TRIM(S002CNM) 
			FROM WEBDBLIB.MWS002M@
			WHERE S002COR = R001COR 
			AND S002COR = I_COR
			AND S002PSCD='RCP_STAT'
			AND S002SCD =  R001STS 
		    ) AS R001STSNM
		, TRIM(R001JMN ) AS R001JMN    -- 주민번호
		, TRIM(R001DTC ) AS R001DTC     --진료의사,진료과목
		, TRIM(R001TRM) AS R001TRM   -- 진료과
		, TRIM(R001WRD) AS R001WRD   -- 병동
		, TRIM(R001GKD) AS R001GKD    --검체종류
		, TRIM(R001OPN ) AS R001OPN    -- 임상소견
		, TRIM(R001RMK) AS R001RMK    --비고
		, TRIM(R001PGY) AS R001PGY    --임신 주차 및 일
	FROM WEBDBLIB.MWR001M@ M
	WHERE R001COR = I_COR
    AND( ( I_REQDIV = 'D' AND R001DAT BETWEEN I_FDT AND I_TDT)--접수일자
		OR ( I_REQDIV = 'C' 
			AND EXISTS (SELECT 1  	
						FROM WEBDBLIB.MWR001D@ D
						WHERE D.R001COR = M.R001COR
						AND D.R001DAT = M.R001DAT
						AND D.R001JNO = M.R001JNO
						AND D.R001CDT BETWEEN I_FDT AND I_TDT
					)) --의뢰일자
		)
	AND (I_NAM = '' OR  R001NAM  LIKE '%'||I_NAM||'%') --환자명
	-- 2022.01.06 복호화 제거
	--AND (I_CHN = '' OR  ECHELON.PI_DECSN(R001CHN)  LIKE I_CHN||'%') --차트번호
	AND (I_CHN = '' OR  R001CHN  LIKE I_CHN||'%') --차트번호
	AND (I_HOS = '' OR  R001HOS  = I_HOS) --병원코드
	AND (I_STS = '' OR  R001STS  = I_STS) --상태
	ORDER BY R001COR,  R001DAT DESC, R001JNO DESC,  R001HOS,R001CHN
	;
			
	OPEN CUR1;
	SET O_ERRCOD = '' ;
	SET O_MSGCOD = '200';
END
