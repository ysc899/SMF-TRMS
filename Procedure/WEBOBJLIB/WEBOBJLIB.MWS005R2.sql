DROP PROCEDURE WEBOBJLIB.MWS005R2;

CREATE PROCEDURE WEBOBJLIB.MWS005R2
(
	  IN I_COR 		VARCHAR(3) 	-- COR
	, IN I_UID 		VARCHAR(12) -- 사용자 ID
	, IN I_IP	  	VARCHAR(30)	-- 로그인 IP
	, OUT O_MSGCOD	CHAR(3)		-- 메세지 코드
	, OUT O_ERRCOD	CHAR(10)	-- 에러 코드
	, IN I_SERID 	VARCHAR(12) -- 조회 ID
)
LANGUAGE SQL
DYNAMIC RESULT SETS 1
BEGIN	
	-- 병원(회원) 관리, 조회 LIST 조회
   DECLARE CUR1  CURSOR WITH RETURN FOR  
	SELECT 
		(SELECT TRIM(S002CNM) 
			FROM WEBDBLIB.MWS002M@ 
			WHERE S002COR = I_COR 
			AND S002PSCD='USER_DIV'  
			AND S002SCD = USERDIV 
			) AS USDNM
		, (SELECT TRIM(S002CNM) 
			FROM WEBDBLIB.MWS002M@ 
			WHERE S002COR = I_COR 
			AND S002PSCD='AUTH'  
			AND S002SCD = S005AGR 
			) AS S005ANM
		, (SELECT TRIM(S002CNM) 
			FROM WEBDBLIB.MWS002M@ 
			WHERE S002COR = I_COR 
			AND S002PSCD='YES_NO'  
			AND S002SCD = S005SYN 
			) AS S005SNMa
		, USERTB.*
	FROM(
		 SELECT TRIM(USRCOR)AS LOGCOR	 -- COR 
			, 'E' AS USERDIV    -- 병원,사용자구분
			, TRIM(USRID) AS LOGLID	 -- LOGIN ID
			, TRIM(S005AGR) AS S005AGR	-- 권한
			, '' AS LOGHOS	 -- 병원코드 
			, TRIM(F910NAM) AS F120FNM	 -- 병원명
			, '' AS F120FL1	 -- 대표상호명
			, '' AS F120GIC	 -- 요양기관코드
			, TRIM(F910PNU) AS LOGTEL	 -- 전화번호 
			, '' AS LOGEML	 -- 멜주소
			, '' AS LOGPO1	 -- 우편번호1
			, '' AS LOGPO2	 -- 우편번호2
			, '' AS LOGADR	 -- 세부주소 
			, '' AS LOGWNO	 -- 대표자명 
			, '' AS LOGGNO	 -- 면허번호 
			, '' AS LOGSNO	 -- 사업자NO 
			, '' AS F120WNO
			, TRIM(S005DRS) AS S005DRS	--원장출신학교
			, TRIM(S005HPH) AS S005HPH	--병원홈페이지
			, TRIM(S005ITM) AS S005ITM		--전문진료과목
			, TRIM(S005POS) AS S005POS	--우편번호
			, TRIM(S005JAD1) AS S005JAD1	--지번 주소1
			, TRIM(S005JAD2) AS S005JAD2	--지번 주소2
			, TRIM(S005DAD1) AS S005DAD1	--도로명 주소1
			, TRIM(S005DAD2) AS S005DAD2	--도로명 주소2
			, TRIM(S005MMO) AS S005MMO	--메모
			, TRIM(S005MRV) AS S005MRV	--메일수신여부(Y/N)
			, TRIM(S005SYN) AS S005SYN	--SMS사용여부
		FROM JMTSLIB.MMUSER@ A
			LEFT JOIN  WEBDBLIB.MWS005M@ MSW005 
				ON S005COR = I_COR
				AND MSW005.S005COR = A.USRCOR 
				AND S005UID = USRID 
			, JMTSLIB.MM910M@ B
		WHERE USRCOR = I_COR
		AND F910COR = I_COR
		AND B.F910COR = USRCOR
		AND USRSAB = F910SAB
		AND F910ODT = 0
		AND USRID = I_SERID	--조회ID
		UNION 
		SELECT 		
				LOGCOR	 -- COR 
			, 'C' AS USERDIV    -- 병원,사용자구분
			, TRIM(LOGLID) AS LOGLID      -- LOGIN ID
			, TRIM(S005AGR) AS S005AGR	-- 권한
			, TRIM(LOGHOS) AS LOGHOS    -- 병원코드 
			, TRIM(F120FNM) AS F120FNM   -- 병원명
			, TRIM(F120FL1) AS F120FL1     -- 대표상호명
			, TRIM(F120GIC) AS F120GIC     -- 요양기관코드
			, TRIM(LOGTEL) AS LOGTEL      -- 전화번호 
			, TRIM(REPLACE(LOGEML,'','')) AS LOGEML    -- 멜주소
			, TRIM(F120PO1) AS LOGPO1     -- 우편번호1
			, TRIM(F120PO2) AS LOGPO2     -- 우편번호2
			, TRIM(REPLACE(LOGADR,'','')) AS LOGADR    -- 세부주소 
			, TRIM(LOGWNO) AS LOGWNO  -- 대표자명 
			, TRIM(LOGGNO) AS LOGGNO   -- 면허번호 
			, TRIM(F120SNO) AS LOGSNO    -- 사업자NO
			, TRIM(F120WNO) AS F120WNO  -- 대표자명 
			, TRIM(S005DRS) AS S005DRS	--원장출신학교
			, TRIM(S005HPH) AS S005HPH	--병원홈페이지
			, TRIM(S005ITM) AS S005ITM		--전문진료과목
			, TRIM(S005POS) AS S005POS	--우편번호
			, TRIM(S005JAD1) AS S005JAD1	--지번 주소1
			, TRIM(S005JAD2) AS S005JAD2	--지번 주소2
			, TRIM(S005DAD1) AS S005DAD1	--도로명 주소1
			, TRIM(S005DAD2) AS S005DAD2	--도로명 주소2
			, TRIM(S005MMO) AS S005MMO	--메모
			, TRIM(S005MRV) AS S005MRV	--메일수신여부(Y/N)
			, TRIM(S005SYN) AS S005SYN	--SMS사용여부
		FROM MCLISDLIB.MCLOGI@ MCLOG
			LEFT JOIN  WEBDBLIB.MWS005M@ MSW005 
				ON S005COR = I_COR
				AND S005COR = MCLOG.LOGCOR 
				AND S005UID = LOGLID 
			, MCLISDLIB.MC120M@ M120
		WHERE LOGCOR = I_COR
		AND MCLOG.LOGCOR = M120.F120COR
		AND MCLOG.LOGHOS = M120.F120PCD
		AND F120STS ='Y'
		AND LOGLID = I_SERID	--조회ID
	)AS USERTB
	ORDER BY USERDIV, F120FNM;

	SET O_MSGCOD = '200';
   OPEN CUR1;
END