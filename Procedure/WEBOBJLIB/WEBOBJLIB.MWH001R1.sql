DROP PROCEDURE WEBOBJLIB.MWH001R1;

CREATE OR REPLACE PROCEDURE WEBOBJLIB.MWH001R1
(
	  IN I_COR 		VARCHAR(3) 	-- COR
	, IN I_UID 		VARCHAR(12) -- 사용자 ID
	, IN I_IP	  	VARCHAR(30)	-- 로그인 IP
	, OUT O_MSGCOD	CHAR(3)		-- 메세지 코드
	, OUT O_ERRCOD	CHAR(10)	-- 에러 코드
	, IN I_SERASB 	VARCHAR(6) -- 사번
	, IN I_SERNM	VARCHAR(12)	-- 담당자명
	, IN I_SERDPT 	VARCHAR(50) -- 부서명
	, IN I_SERHOS 	VARCHAR(40) -- 병원명
)
LANGUAGE SQL
DYNAMIC RESULT SETS 1
BEGIN	
	
	-- 담당병원만 검색할지 말지 Flag
   	DECLARE V_HRC  VARCHAR(20) ;
	
	-- 담당병원만 검색할지 말지 Flag
    SELECT
        -- 지점장/지점직원의 경우, 해당 지점이 담당하는 병원만 조회 가능하도록 한다.
        CASE WHEN A.S005AGR IN ('BRC_MNG','HOSP_NMG','TEST') THEN '' ELSE B.S003HRC END INTO V_HRC
    FROM WEBDBLIB.MWS005M@ A , WEBDBLIB.MWS003M@ B
    WHERE A.S005COR = B.S003COR
    AND A.S005AGR = B.S003ACD
    AND A.S005COR = I_COR
    AND A.S005UID = I_UID 
    LIMIT 1;
	 
    IF V_HRC = '' THEN -- 지점장/지점직원의 경우, 해당 지점이 담당하는 병원만 조회 가능하도록 한다.
		IF I_SERHOS = '' THEN 
			SET O_MSGCOD = '200';
		
			BEGIN
				-- 담당자별 병원 관리, 조회 LIST 조회
			   DECLARE CUR1  CURSOR WITH RETURN FOR  
				SELECT TRIM(F910SAB) AS F910SAB
					,TRIM(F910NAM) AS F910NAM
					,TRIM(F910DPT) AS F910DPT
					,TRIM(F900KNM) AS F900KNM
					,(SELECT COUNT(*) 
							FROM MCLISDLIB.MC120M@  
							WHERE F120COR = F910COR
							AND F120MBC = F910SAB) HOSCNT
				FROM JMTSLIB.MM910M@ MM910M
					LEFT JOIN JMTSLIB.MM900M@ MM900 
						ON MM900.F900COR = MM910M.F910COR
						AND MM900.F900DPT = MM910M.F910DPT 
				WHERE F910COR = I_COR
				AND   F910SAB = (SELECT F910SAB				-- ID로 사번 가져오기
								FROM JMTSLIB.MMUSER@ B,JMTSLIB.MM910M@ G 
								WHERE B.USRCOR = G.F910COR
								AND B.USRSAB = G.F910SAB
								AND B.USRID = I_UID 
				)
				AND (I_SERASB ='' OR F910SAB LIKE  I_SERASB||'%')
				AND (I_SERNM = '' OR F910NAM LIKE '%'||I_SERNM||'%')
				AND (I_SERDPT = '' OR F900KNM LIKE '%'||I_SERDPT||'%')
				ORDER BY F910SAB, F910NAM;
			
				OPEN CUR1;
			
			END;
		ELSE
			SET O_MSGCOD = '200';
			BEGIN
				-- 담당자별 병원 관리, 조회 LIST 조회
			   DECLARE CUR1  CURSOR WITH RETURN FOR  
				SELECT TRIM(F910SAB) AS F910SAB
					,TRIM(F910NAM) AS F910NAM
					,TRIM(F910DPT) AS F910DPT
					,TRIM(F900KNM) AS F900KNM
					,(SELECT COUNT(*) 
							FROM MCLISDLIB.MC120M@  
							WHERE F120COR = F910COR 
							AND F120MBC = F910SAB) HOSCNT
				FROM JMTSLIB.MM910M@ MM910M
					LEFT JOIN JMTSLIB.MM900M@ MM900 
						ON MM900.F900COR = MM910M.F910COR
						AND MM900.F900DPT = MM910M.F910DPT 
				WHERE F910COR = I_COR
				AND   F910SAB = (SELECT F910SAB				-- ID로 사번 가져오기
								FROM JMTSLIB.MMUSER@ B,JMTSLIB.MM910M@ G 
								WHERE B.USRCOR = G.F910COR
								AND B.USRSAB = G.F910SAB
								AND B.USRID = I_UID 
				)
				AND (I_SERASB ='' OR F910SAB LIKE  I_SERASB||'%')
				AND (I_SERNM = '' OR F910NAM LIKE '%'||I_SERNM||'%')
				AND (I_SERDPT = '' OR F900KNM LIKE '%'||I_SERDPT||'%')
				AND EXISTS (SELECT 1 
							FROM MCLISDLIB.MC120M@  
							WHERE F120COR = F910COR
							AND  F120MBC = F910SAB
							AND F120FNM LIKE I_SERHOS||'%')
				ORDER BY F910SAB,F910NAM;
				OPEN CUR1;
			END;
		END IF;
	ELSE	-- 지점장/지점직원의 아닌 경우, 모든 지점의 병원 조회 가능하도록 한다.
		IF I_SERHOS = '' THEN 
			SET O_MSGCOD = '200';
		
			BEGIN
				-- 담당자별 병원 관리, 조회 LIST 조회
			   DECLARE CUR1  CURSOR WITH RETURN FOR  
				SELECT TRIM(F910SAB) AS F910SAB
					,TRIM(F910NAM) AS F910NAM
					,TRIM(F910DPT) AS F910DPT
					,TRIM(F900KNM) AS F900KNM
					,(SELECT COUNT(*) 
							FROM MCLISDLIB.MC120M@  
							WHERE F120COR = F910COR
							AND F120MBC = F910SAB) HOSCNT
				FROM JMTSLIB.MM910M@ MM910M
					LEFT JOIN JMTSLIB.MM900M@ MM900 
						ON MM900.F900COR = MM910M.F910COR
						AND MM900.F900DPT = MM910M.F910DPT 
				WHERE F910COR = I_COR
				AND (I_SERASB ='' OR F910SAB LIKE  I_SERASB||'%')
				AND (I_SERNM = '' OR F910NAM LIKE '%'||I_SERNM||'%')
				AND (I_SERDPT = '' OR F900KNM LIKE '%'||I_SERDPT||'%')
				ORDER BY F910SAB, F910NAM;
			
				OPEN CUR1;
			
			END;
		ELSE
			SET O_MSGCOD = '200';
			BEGIN
				-- 담당자별 병원 관리, 조회 LIST 조회
			   DECLARE CUR1  CURSOR WITH RETURN FOR  
				SELECT TRIM(F910SAB) AS F910SAB
					,TRIM(F910NAM) AS F910NAM
					,TRIM(F910DPT) AS F910DPT
					,TRIM(F900KNM) AS F900KNM
					,(SELECT COUNT(*) 
							FROM MCLISDLIB.MC120M@  
							WHERE F120COR = F910COR 
							AND F120MBC = F910SAB) HOSCNT
				FROM JMTSLIB.MM910M@ MM910M
					LEFT JOIN JMTSLIB.MM900M@ MM900 
						ON MM900.F900COR = MM910M.F910COR
						AND MM900.F900DPT = MM910M.F910DPT 
				WHERE F910COR = I_COR
				AND (I_SERASB ='' OR F910SAB LIKE  I_SERASB||'%')
				AND (I_SERNM = '' OR F910NAM LIKE '%'||I_SERNM||'%')
				AND (I_SERDPT = '' OR F900KNM LIKE '%'||I_SERDPT||'%')
				AND EXISTS (SELECT 1 
							FROM MCLISDLIB.MC120M@  
							WHERE F120COR = F910COR
							AND  F120MBC = F910SAB
							AND F120FNM LIKE I_SERHOS||'%')
				ORDER BY F910SAB,F910NAM;
				OPEN CUR1;
			END;
		END IF;
	END IF;
END



